name: Deploy Profile Service (artifact)

on:
  push:
    branches: [main]

concurrency:
  group: deploy-profile
  cancel-in-progress: true

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Use Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      # ‚úÖ Install dependencies
      - name: Install dependencies (CI)
        run: npm ci

      # ‚úÖ Prisma validate + generate (CI)
      - name: Prisma Validate
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        run: npx prisma validate

      - name: Prisma Generate
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        run: npx prisma generate

      # ‚úÖ Build
      - name: Build
        run: npm run build

      # ‚úÖ Create deploy bundle
      - name: Create deploy bundle
        run: |
          mkdir -p deploy
          cp -r dist deploy/
          cp package.json package-lock.json deploy/
          if [ -d prisma ]; then cp -r prisma deploy/; fi
          tar -czf deploy.tgz -C deploy .

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts

      # ‚úÖ Upload artifact
      - name: Upload bundle to EC2
        run: |
          scp -i ~/.ssh/id_ed25519 deploy.tgz \
            ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}:/tmp/profile.tgz

      # ‚úÖ Deploy on EC2 (NO db push / NO migrate)
      - name: Deploy on EC2 (release + symlink)
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        run: |
          ssh -i ~/.ssh/id_ed25519 ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} "DATABASE_URL='${DATABASE_URL}' bash -s" << 'EOF'
            set -euo pipefail

            # üîë Load NVM (if used)
            export NVM_DIR="$HOME/.nvm"
            [ -s "$NVM_DIR/nvm.sh" ] && . "$NVM_DIR/nvm.sh"

            node -v
            npm -v

            ROOT="/home/ubuntu/loveyatri"
            SERVICE_DIR="$ROOT/profile"
            RELEASES="$SERVICE_DIR/releases"
            TS="$(date +%Y%m%d_%H%M%S)"
            NEW_RELEASE="$RELEASES/$TS"

            echo "üì¶ Deploying Profile -> $NEW_RELEASE"

            mkdir -p "$NEW_RELEASE"
            tar -xzf /tmp/profile.tgz -C "$NEW_RELEASE"
            rm -f /tmp/profile.tgz

            cd "$NEW_RELEASE"

            # ‚úÖ Install production deps only
            npm ci --omit=dev --no-audit --no-fund

            # ‚úÖ Prisma generate only (no DB changes)
            if [ -d prisma ]; then
              if [ -z "${DATABASE_URL:-}" ]; then
                echo "‚ùå DATABASE_URL is empty in deploy session"
                exit 1
              fi
              echo "üß¨ Prisma generate (no DB changes)"
              npx prisma generate
            fi

            # ‚úÖ Switch symlink
            ln -sfn "$NEW_RELEASE" "$SERVICE_DIR/current"

            # ‚úÖ Keep last 5 releases
            cd "$RELEASES"
            ls -1dt */ | tail -n +6 | xargs -r rm -rf

            echo "‚ôªÔ∏è Reloading PM2 via ecosystem"
            pm2 reload "$ROOT/ecosystem.config.js" --update-env || pm2 restart "$ROOT/ecosystem.config.js" --update-env
            pm2 save

            echo "‚úÖ Deployment successful"
          EOF
